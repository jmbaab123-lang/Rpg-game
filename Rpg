<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>RPG Retro V3 (Corregido)</title>
    <style>
        /* Estilos para asegurar visibilidad */
        body {
            background-color: #2a2a2a; /* Gris para distinguir del canvas */
            color: white;
            font-family: 'Courier New', monospace;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100vh;
            margin: 0;
            overflow: hidden;
        }

        /* Men√∫ de inicio */
        #start-screen {
            background: #000;
            border: 4px solid #fff;
            padding: 20px;
            text-align: center;
            z-index: 10;
        }

        .btn-group { margin: 10px 0; }
        
        button {
            background: #222;
            color: #fff;
            border: 2px solid #555;
            padding: 10px 15px;
            margin: 5px;
            cursor: pointer;
            font-size: 14px;
            font-weight: bold;
        }
        button:hover { background: #444; border-color: gold; }
        button.selected { background: #fff; color: #000; border-color: gold; }

        /* Contenedor del Juego */
        #game-wrapper {
            display: none; /* Oculto hasta empezar */
            flex-direction: column;
            align-items: center;
        }

        canvas {
            background-color: #000;
            border: 4px solid gold; /* Borde dorado para ver si carg√≥ */
            box-shadow: 0 0 30px rgba(0,0,0,0.8);
        }

        #ui {
            width: 600px;
            background: #111;
            border: 4px solid #fff;
            border-top: none;
            padding: 10px;
            display: flex;
            justify-content: space-between;
            box-sizing: border-box;
            font-size: 14px;
        }

        /* Barras de vida */
        .bar { width: 100px; height: 10px; background: #333; display: inline-block; }
        .bar-fill { height: 100%; transition: width 0.2s; }
        
        #combat-controls { display: none; }
        .log-msg { color: #aaa; margin: 2px 0; }
        .log-important { color: gold; font-weight: bold; }
    </style>
</head>
<body>

    <!-- PANTALLA DE INICIO -->
    <div id="start-screen">
        <h1 style="color:gold">‚öîÔ∏è RPG RETRO ‚öîÔ∏è</h1>
        <p>Selecciona tu personaje:</p>
        
        <div class="btn-group">
            <button onclick="setRace('Humano', this)" class="r-btn selected">Humano üõ°Ô∏è</button>
            <button onclick="setRace('Elfo', this)" class="r-btn">Elfo üßù</button>
            <button onclick="setRace('Orco', this)" class="r-btn">Orco üßå</button>
        </div>
        
        <div class="btn-group">
            <button onclick="setJob('Guerrero', this)" class="j-btn selected">Guerrero ‚öîÔ∏è</button>
            <button onclick="setJob('Mago', this)" class="j-btn">Mago üîÆ</button>
        </div>

        <br>
        <button onclick="initGame()" style="font-size: 20px; border-color: gold; color: gold; width: 100%">COMENZAR JUEGO</button>
    </div>

    <!-- PANTALLA DE JUEGO -->
    <div id="game-wrapper">
        <canvas id="cvs" width="600" height="400"></canvas>
        
        <div id="ui">
            <div id="log" style="width: 60%; height: 100px; overflow-y:auto; font-size: 12px;"></div>
            <div style="width: 35%; text-align: right;">
                <div id="stats-display">Nivel 1</div>
                HP: <div class="bar"><div id="hp-bar" class="bar-fill" style="background:red; width:100%"></div></div><br>
                MP: <div class="bar"><div id="mp-bar" class="bar-fill" style="background:blue; width:100%"></div></div>
                
                <div id="combat-controls" style="margin-top:10px;">
                    <button onclick="action('atk')">ATACAR</button>
                    <button onclick="action('mag')">MAGIA</button>
                </div>
            </div>
        </div>
    </div>

<script>
    // --- VARIABLES GLOBALES ---
    let ctx, canvas;
    let gameLoopId;
    
    let state = {
        screen: 'MENU', // MENU, MAP, COMBAT
        race: 'Humano',
        job: 'Guerrero',
        player: { x:1, y:1, hp:100, maxHp:100, mp:50, maxMp:50, lvl:1, xp:0, nextXp:100 },
        map: [],
        enemy: null,
        msg: []
    };

    const TILE = 40;
    const ROWS = 10;
    const COLS = 15;

    const ICONS = {
        'Humano': 'üõ°Ô∏è', 'Elfo': 'üßù', 'Orco': 'üßå',
        'Slime': 'ü¶†', 'Esqueleto': 'üíÄ', 'Ogro': 'üëπ',
        'Muro': 'üß±', 'Puerta': 'üö™'
    };

    // --- CONFIGURACI√ìN INICIAL ---
    window.onload = function() {
        canvas = document.getElementById('cvs');
        ctx = canvas.getContext('2d');
        
        // Listener de teclado
        window.addEventListener('keydown', (e) => {
            if(state.screen === 'MAP') movePlayer(e);
        });
        
        console.log("Juego cargado correctamente.");
    };

    function setRace(r, btn) {
        state.race = r;
        document.querySelectorAll('.r-btn').forEach(b => b.classList.remove('selected'));
        btn.classList.add('selected');
    }
    
    function setJob(j, btn) {
        state.job = j;
        document.querySelectorAll('.j-btn').forEach(b => b.classList.remove('selected'));
        btn.classList.add('selected');
    }

    function initGame() {
        // Configurar stats
        let p = state.player;
        if(state.race === 'Orco') { p.maxHp = 150; p.hp = 150; }
        if(state.race === 'Elfo') { p.maxMp = 100; p.mp = 100; p.maxHp = 80; p.hp = 80; }
        
        // Cambiar pantalla
        document.getElementById('start-screen').style.display = 'none';
        document.getElementById('game-wrapper').style.display = 'flex';
        
        addLog("Bienvenido a la mazmorra.");
        generateMap();
        state.screen = 'MAP';
        updateUI();
        
        // Iniciar bucle de dibujo
        gameLoop();
    }

    // --- BUCLE PRINCIPAL (Evita pantalla negra) ---
    function gameLoop() {
        draw();
        requestAnimationFrame(gameLoop);
    }

    // --- DIBUJADO ---
    function draw() {
        // Limpiar pantalla
        ctx.fillStyle = "#000";
        ctx.fillRect(0, 0, canvas.width, canvas.height);

        if (state.screen === 'MAP') {
            // Dibujar mapa
            for(let r=0; r<ROWS; r++){
                for(let c=0; c<COLS; c++){
                    let t = state.map[r][c];
                    let x = c*TILE, y = r*TILE;
                    
                    if(t===1) { // Muro
                        ctx.fillStyle = "#444";
                        ctx.fillRect(x, y, TILE, TILE);
                        ctx.strokeStyle = "#222";
                        ctx.strokeRect(x, y, TILE, TILE);
                    }
                    if(t===2) { // Puerta
                        ctx.font = "30px Arial";
                        ctx.fillText(ICONS['Puerta'], x+5, y+30);
                    }
                }
            }
            // Dibujar Jugador
            ctx.font = "30px Arial";
            ctx.fillText(ICONS[state.race], state.player.x*TILE + 5, state.player.y*TILE + 30);
        
        } else if (state.screen === 'COMBAT') {
            // Fondo combate
            ctx.fillStyle = "#220000";
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            
            // Texto VS
            ctx.fillStyle = "white"; 
            ctx.font = "40px Courier New";
            ctx.textAlign = "center";
            ctx.fillText("COMBATE", 300, 50);

            // Jugador (Izq)
            ctx.font = "60px Arial";
            ctx.fillText(ICONS[state.race], 150, 200);
            ctx.font = "20px Arial";
            ctx.fillText("T√ö", 150, 250);

            // Enemigo (Der)
            if(state.enemy) {
                ctx.font = "100px Arial";
                ctx.fillText(ICONS[state.enemy.type], 450, 200);
                
                // Vida enemigo
                let pct = (state.enemy.hp / state.enemy.maxHp) * 100;
                ctx.fillStyle = "red";
                ctx.fillRect(400, 260, 100, 10);
                ctx.fillStyle = "#0f0";
                ctx.fillRect(400, 260, Math.max(0, pct), 10);
                
                ctx.fillStyle = "white";
                ctx.font = "16px Arial";
                ctx.fillText(state.enemy.type, 450, 290);
            }
            
            ctx.textAlign = "start"; // Reset alineaci√≥n
        }
    }

    // --- L√ìGICA DEL MAPA ---
    function generateMap() {
        state.map = [];
        for(let r=0; r<ROWS; r++){
            let row = [];
            for(let c=0; c<COLS; c++){
                // Bordes
                if(r===0 || r===ROWS-1 || c===0 || c===COLS-1) row.push(1);
                else if(Math.random() < 0.2) row.push(1);
                else row.push(0);
            }
            state.map.push(row);
        }
        // Asegurar entrada y salida
        state.player.x = 1; state.player.y = 1;
        state.map[1][1] = 0;
        state.map[ROWS-2][COLS-2] = 2; // Puerta
    }

    function movePlayer(e) {
        let dx=0, dy=0;
        if(e.key === "ArrowUp") dy = -1;
        if(e.key === "ArrowDown") dy = 1;
        if(e.key === "ArrowLeft") dx = -1;
        if(e.key === "ArrowRight") dx = 1;

        let nx = state.player.x + dx;
        let ny = state.player.y + dy;

        if(state.map[ny][nx] !== 1) {
            state.player.x = nx;
            state.player.y = ny;

            if(state.map[ny][nx] === 2) {
                state.player.lvl++;
                addLog("¬°Nivel completado! Subes de nivel.");
                generateMap();
            }
            else if(Math.random() < 0.1) {
                startCombat();
            }
        }
    }

    // --- COMBATE ---
    function startCombat() {
        state.screen = 'COMBAT';
        document.getElementById('combat-controls').style.display = 'block';
        
        let enemies = ['Slime', 'Esqueleto', 'Ogro'];
        let type = enemies[Math.floor(Math.random()*enemies.length)];
        
        state.enemy = {
            type: type,
            hp: 30 + (state.player.lvl*10),
            maxHp: 30 + (state.player.lvl*10),
            atk: 5 + state.player.lvl
        };
        addLog("¬°Un " + type + " salvaje apareci√≥!");
    }

    function action(act) {
        if(!state.enemy) return;

        // Turno Jugador
        let dmg = 10 + state.player.lvl;
        if(act === 'mag') dmg *= 2; // Magia fuerte
        
        state.enemy.hp -= dmg;
        addLog("Haces " + dmg + " de da√±o.");

        if(state.enemy.hp <= 0) {
            addLog("¬°Victoria!");
            state.screen = 'MAP';
            document.getElementById('combat-controls').style.display = 'none';
            return;
        }

        // Turno Enemigo
        let eDmg = state.enemy.atk;
        state.player.hp -= eDmg;
        addLog(state.enemy.type + " ataca: -" + eDmg + " HP.");
        updateUI();

        if(state.player.hp <= 0) {
            alert("Has muerto. Reiniciando piso...");
            state.player.hp = state.player.maxHp;
            state.player.x = 1; state.player.y = 1;
            state.screen = 'MAP';
            document.getElementById('combat-controls').style.display = 'none';
            updateUI();
        }
    }

    // --- UI Y LOGS ---
    function addLog(txt) {
        let div = document.getElementById('log');
        div.innerHTML += `<div class="log-msg">> ${txt}</div>`;
        div.scrollTop = div.scrollHeight;
    }

    function updateUI() {
        let p = state.player;
        document.getElementById('stats-display').innerText = state.race + " Nvl " + p.lvl;
        
        let hpPct = (p.hp / p.maxHp) * 100;
        let mpPct = (p.mp / p.maxMp) * 100;
        
        document.getElementById('hp-bar').style.width = Math.max(0, hpPct) + "%";
        document.getElementById('mp-bar').style.width = Math.max(0, mpPct) + "%";
    }

</script>
</body>
</html>
